<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('Referrals - Solace')}"></head>
<body>
    <!-- Background Layer -->
    <div th:replace="~{fragments/layout :: blobs}"></div>
    
    <!-- Mobile Header -->
    <div th:replace="~{fragments/layout :: mobile-header}"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar-counsellor}"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header fade-in">
                <h1 class="page-title">
                    <span>üìã</span> Referrals
                </h1>
                <p class="page-subtitle">Manage faculty referrals for at-risk students</p>
            </div>
            
            <!-- Success Message -->
            <div th:if="${success}" class="alert alert-success" style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(129, 178, 154, 0.15); border: 1px solid rgba(129, 178, 154, 0.3); color: var(--accent-2);">
                <span th:text="${success}">Success</span>
            </div>
            
            <!-- Pending Referrals -->
            <div class="card hover-lift" style="margin-bottom: 24px;">
                <div class="card-header">
                    <span class="card-title"><i class="bi bi-inbox"></i> Pending Referrals</span>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(pendingReferrals)}" class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">No pending referrals</div>
                    </div>
                    
                    <div th:each="ref : ${pendingReferrals}" class="referral-item" style="border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span class="urgency-badge"
                                      th:classappend="${ref.urgency}"
                                      th:text="${ref.urgency}">Urgency</span>
                                <strong th:text="${ref.studentIdentifier}">Student</strong>
                                <span class="status-badge" th:text="${ref.status}">Status</span>
                            </div>
                            <small style="color: var(--text-muted);" th:text="${#temporals.format(ref.createdAt, 'MMM dd, yyyy')}">Date</small>
                        </div>
                        <p style="margin-bottom: 8px; color: var(--text-secondary);" th:text="${ref.summary}">Summary</p>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px;">Referred by: <span th:text="${ref.faculty.displayName}">Faculty</span></p>
                        
                        <form th:action="@{/counsellor/referrals/{id}/assign(id=${ref.id})}" method="post" style="display: inline;"
                              th:if="${ref.assignedCounsellor == null}">
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bi bi-person-plus"></i> Assign to Me
                            </button>
                        </form>
                        
                        <form th:action="@{/counsellor/referrals/{id}/status(id=${ref.id})}" method="post" style="display: inline;"
                              th:if="${ref.status.name() == 'IN_REVIEW'}">
                            <input type="hidden" name="status" value="CLOSED">
                            <button type="submit" class="btn btn-sm btn-outline" style="margin-left: 8px;">
                                <i class="bi bi-check"></i> Close Referral
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- My Referrals -->
            <div class="card hover-lift">
                <div class="card-header">
                    <span class="card-title"><i class="bi bi-person-check"></i> My Assigned Referrals</span>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(myReferrals)}" class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-title">No assigned referrals</div>
                    </div>
                    
                    <div class="table-responsive" th:unless="${#lists.isEmpty(myReferrals)}">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Urgency</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="ref : ${myReferrals}">
                                    <td th:text="${ref.studentIdentifier}">Student</td>
                                    <td><span class="urgency-badge" th:classappend="${ref.urgency}" th:text="${ref.urgency}">Urgency</span></td>
                                    <td><span class="status-badge" th:text="${ref.status}">Status</span></td>
                                    <td th:text="${#temporals.format(ref.createdAt, 'MMM dd')}">Date</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="page-footer">
                <p>¬© 2025 Solace Mental Health Hub</p>
                <p>Your wellbeing matters. If you're in crisis, please call emergency services.</p>
            </div>
        </main>
    </div>
    
    <style>
        .urgency-badge { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; }
        .urgency-badge.HIGH { background: rgba(220, 38, 38, 0.15); color: #dc2626; }
        .urgency-badge.MEDIUM { background: rgba(251, 191, 36, 0.15); color: #b45309; }
        .urgency-badge.LOW { background: var(--surface-2); color: var(--text-secondary); }
    </style>
    
    <!-- Mobile Navigation -->
    <nav th:replace="~{fragments/layout :: mobile-nav-counsellor}"></nav>
    <div th:replace="~{fragments/layout :: mobile-menu-counsellor}"></div>
    
    <div th:replace="~{fragments/layout :: scripts}"></div>
</body>
</html>
